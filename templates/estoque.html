{% extends "base.html" %}
{% block content %}

<div class="container-fluid py-4">

  <!-- Cabe√ßalho -->
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
    <h3 class="fw-bold text-white mb-0">üì¶ Painel de Estoque</h3>
    <div class="d-flex flex-wrap gap-2">

      <!-- ‚úÖ Novo Item -->
      <!-- <button class="btn btn-primary d-flex align-items-center gap-2"
              data-bs-toggle="modal"
              data-bs-target="#novoItemModal">
        <i data-lucide="plus-circle"></i> Novo Item
      </button> -->

      <!-- ‚úÖ Entrada -->
      <a href="{{ url_for('estoque.novo_material') }}"
         class="btn btn-success d-flex align-items-center gap-2">
        <i data-lucide="arrow-down-circle"></i> Entrada
      </a>

      <!-- ‚úÖ Sa√≠da -->
      <a href="{{ url_for('estoque.saida_estoque') }}"
         class="btn btn-warning d-flex align-items-center gap-2 text-dark">
        <i data-lucide="arrow-up-circle"></i> Sa√≠da
      </a>

      <!-- ‚úÖ Hist√≥rico -->
      <a href="{{ url_for('estoque.historico_estoque') }}"
         class="btn btn-outline-light d-flex align-items-center gap-2">
        <i data-lucide="clock-history"></i> Hist√≥rico
      </a>

      <!-- ‚úÖ Ver Todos -->
      <a href="{{ url_for('estoque.lista_estoque') }}"
         class="btn btn-outline-info d-flex align-items-center gap-2">
        <i data-lucide="list"></i> Ver Todos
      </a>
    </div>
  </div>

  <!-- Cards de resumo -->
  <div class="row g-4 mb-4">
    <div class="col-md-4">
      <div class="card p-4 h-100 border-0 shadow-sm bg-dark text-white">
        <h6 class="fw-bold mb-2"><i data-lucide="archive"></i> Total de Itens</h6>
        <h2 class="fw-bold text-primary">{{ itens|length }}</h2>
        <small class="text-secondary">Itens registrados no sistema</small>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card p-4 h-100 border-0 shadow-sm bg-dark text-white">
        <h6 class="fw-bold mb-2"><i data-lucide="download"></i> Entradas</h6>
        <h2 class="fw-bold text-success">{{ entradas or 0 }}</h2>
        <small class="text-secondary">Movimenta√ß√µes de entrada</small>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card p-4 h-100 border-0 shadow-sm bg-dark text-white">
        <h6 class="fw-bold mb-2"><i data-lucide="upload"></i> Sa√≠das</h6>
        <h2 class="fw-bold text-danger">{{ saidas or 0 }}</h2>
        <small class="text-secondary">Movimenta√ß√µes de sa√≠da</small>
      </div>
    </div>
  </div>

  <!-- Gr√°fico -->
  <div class="card bg-dark border-0 shadow-lg p-4 mb-5">
    <h5 class="fw-bold text-white mb-3">
      <i data-lucide="pie-chart"></i> Distribui√ß√£o por Categoria
    </h5>
    <canvas id="chartCategorias" height="140"></canvas>
  </div>

  <!-- Tabela resumida -->
  <div class="card bg-dark border-0 shadow-lg p-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="fw-bold text-white mb-0">
        <i data-lucide="list"></i> Itens Recentes
      </h5>
      <a href="{{ url_for('estoque.lista_estoque') }}" class="btn btn-sm btn-outline-info">
        <i data-lucide="arrow-right"></i> Ver Lista Completa
      </a>
    </div>

    <div class="table-responsive">
  <table class="table table-dark table-hover align-middle rounded-3 overflow-hidden">
    <thead class="bg-black bg-opacity-50">
      <tr class="text-secondary small text-uppercase">
        <th>ID</th>
        <th>Nome</th>
        <th>Categoria</th>
        <th>Unidade</th>
        <th>Qtd</th>
        <th>Status</th>
        <th>√öltima Movimenta√ß√£o</th>
      </tr>
    </thead>
    <tbody>
      {% for item in itens %}
      <tr>
        <td>{{ item.id }}</td>
        <td>{{ item.nome }}</td>
        <td>{{ item.categoria or '‚Äî' }}</td>
        <td>{{ item.unidade or '‚Äî' }}</td>
        <td>{{ item.quantidade }}</td>
        <td>
          {% if item.status == 'Dispon√≠vel' %}
            <span class="badge bg-success">{{ item.status }}</span>
          {% elif item.status == 'Reservado' %}
            <span class="badge bg-warning text-dark">{{ item.status }}</span>
          {% elif item.status == 'Baixo Estoque' %}
            <span class="badge bg-danger">{{ item.status }}</span>
          {% else %}
            <span class="badge bg-secondary">‚Äî</span>
          {% endif %}
        </td>
        <td>
          {% set mov = item.movimentacoes|sort(attribute='timestamp', reverse=True)|first %}
          {{ mov.timestamp.strftime('%d/%m/%Y %H:%M') if mov else '‚Äî' }}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

    {% if not itens %}
    <div class="text-center text-secondary py-4">Nenhum item cadastrado no estoque.</div>
    {% endif %}
  </div>
</div>

<!-- Modal Novo Item -->
{% include 'modais/novo_item.html' %}

<script>
  lucide.createIcons();

  // ‚úÖ Protege o gr√°fico contra erro de JSON
  const ctx = document.getElementById('chartCategorias');
  const categoriasRaw = JSON.parse('{{ categorias_data | tojson | safe if categorias_data else "{}" }}');
  const categoriasData = categoriasRaw || {};

  if (Object.keys(categoriasData).length > 0) {
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: Object.keys(categoriasData),
        datasets: [{
          data: Object.values(categoriasData),
          backgroundColor: ['#0d6efd','#198754','#ffc107','#dc3545','#6f42c1'],
          borderWidth: 0
        }]
      },
      options: {
        plugins: { legend: { position: 'bottom', labels: { color: '#ccc' } } },
        cutout: '65%',
        animation: { duration: 800, easing: 'easeInOutQuad' }
      }
    });
  }
</script>

{% endblock %}
