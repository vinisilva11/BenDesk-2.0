{% extends "base.html" %}
{% block content %}
<div class="container-fluid py-4">

  <!-- Cabe√ßalho -->
    <div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="fw-bold text-white mb-0">üéüÔ∏è Lista de Chamados</h3>
    <div class="d-flex gap-2">
      <a href="{{ url_for('new_ticket') }}" class="btn btn-success">
        <i data-lucide="plus-circle"></i> Novo Chamado
      </a>
      <a href="{{ url_for('chamados_painel') }}" class="btn btn-outline-light">
        <i data-lucide="arrow-left"></i> Voltar ao Painel
      </a>
    </div>
  </div>


  <!-- Filtros -->
  <form method="get" class="row g-3 mb-4">
    <div class="col-md-4">
      <label for="status_filter" class="form-label text-secondary small">Status</label>
      <select class="form-select bg-dark text-white border-secondary" name="status_filter" id="status_filter">
        <option value="">Todos</option>
        <option value="Aberto" {% if request.args.get('status_filter') == 'Aberto' %}selected{% endif %}>Aberto</option>
        <option value="Em Andamento" {% if request.args.get('status_filter') == 'Em Andamento' %}selected{% endif %}>Em Andamento</option>
        <option value="Fechados" {% if request.args.get('status_filter') == 'Fechados' %}selected{% endif %}>Encerrado/Cancelado</option>
      </select>
    </div>
    <div class="col-md-4">
      <label for="responsavel_filter" class="form-label text-secondary small">Respons√°vel</label>
      <input type="text" class="form-control bg-dark text-white border-secondary"
             name="responsavel_filter"
             placeholder="Buscar respons√°vel"
             value="{{ request.args.get('responsavel_filter', '') }}">
    </div>
    <div class="col-md-4 d-flex align-items-end">
      <button class="btn btn-primary me-2" type="submit">
        <i data-lucide="filter"></i> Filtrar
      </button>
      <a href="{{ url_for('my_tickets') }}" class="btn btn-outline-light">
        <i data-lucide="refresh-ccw"></i> Limpar
      </a>
    </div>
  </form>

  <!-- Tabela -->
  <div class="table-responsive">
    <table class="table table-dark table-hover align-middle rounded-3 overflow-hidden shadow-sm">
      <thead class="bg-black bg-opacity-50">
        <tr class="text-secondary text-uppercase small">
          <th>ID</th>
          <th>T√≠tulo</th>
          <th>Solicitante</th>
          <th>Respons√°vel</th>
          <th>Status</th>
          <th>Prioridade</th>
          <th>SLA</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
        {% for ticket in tickets %}
        <tr>
          <td class="fw-semibold text-white">#{{ ticket.id }}</td>
          <td class="text-white">{{ ticket.title }}</td>

          <!-- Avatar + Email do solicitante -->
          <td class="d-flex align-items-center gap-3">
            {% set avatar_file = (ticket.requester_email|replace('@','_')|replace('.','_') ~ '.jpg') %}
            {% set avatar_path = 'uploads/avatars/' ~ avatar_file %}
            {% if avatar_file in existing_avatars %}
              <img src="{{ url_for('static', filename=avatar_path) }}"
                   alt="Avatar"
                   class="rounded-circle"
                   width="40"
                   height="40"
                   style="object-fit: cover; border: 2px solid rgba(255,255,255,0.15);">
            {% else %}
              <img src="{{ url_for('static', filename='img/default-avatar.png') }}"
                   alt="Avatar padr√£o"
                   class="rounded-circle"
                   width="40"
                   height="40"
                   style="opacity: 0.8; border: 2px solid rgba(255,255,255,0.1);">
            {% endif %}
            <div>
              <div class="fw-semibold text-white small">{{ ticket.requester_name or '‚Äî' }}</div>
              <div class="text-secondary small">{{ ticket.requester_email or '‚Äî' }}</div>
            </div>
          </td>

          <td class="text-white">{{ ticket.assigned_to or '‚Äî' }}</td>

          <td>
            {% if ticket.status == 'Aberto' %}
              <span class="badge bg-primary">{{ ticket.status }}</span>
            {% elif ticket.status == 'Em Andamento' %}
              <span class="badge bg-warning text-dark">{{ ticket.status }}</span>
            {% elif ticket.status == 'Encerrado' %}
              <span class="badge bg-success">{{ ticket.status }}</span>
            {% else %}
              <span class="badge bg-secondary">{{ ticket.status }}</span>
            {% endif %}
          </td>

          <td>
            {% if ticket.priority == 'Alta' %}
              <span class="badge bg-danger">{{ ticket.priority }}</span>
            {% elif ticket.priority == 'M√©dia' %}
              <span class="badge bg-warning text-dark">{{ ticket.priority }}</span>
            {% else %}
              <span class="badge bg-secondary">{{ ticket.priority }}</span>
            {% endif %}
          </td>

          <td>
              <span class="badge {{ ticket.sla.cor }}">{{ ticket.sla.texto }}</span>
          </td>

          <td>
            <a href="{{ url_for('view_ticket', ticket_id=ticket.id) }}" class="btn btn-sm btn-outline-info">
              <i data-lucide="eye"></i>
            </a>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="7" class="text-center text-secondary py-4">Nenhum chamado encontrado.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagina√ß√£o -->
{% if total_pages > 1 %}
  <nav aria-label="Navega√ß√£o de p√°ginas" class="mt-4">
    <ul class="pagination justify-content-center pagination-sm">

      {% if has_prev %}
        <li class="page-item">
          <a class="page-link bg-dark text-white border-secondary"
             href="{{ url_for('my_tickets', page=prev_page) }}">
            ¬´ Anterior
          </a>
        </li>
      {% else %}
        <li class="page-item disabled">
          <span class="page-link bg-dark text-secondary border-secondary">¬´ Anterior</span>
        </li>
      {% endif %}

      {% for p in range(1, total_pages + 1) %}
        <li class="page-item {% if p == current_page %}active{% endif %}">
          <a class="page-link bg-dark text-white border-secondary" href="{{ url_for('my_tickets', page=p) }}">
            {{ p }}
          </a>
        </li>
      {% endfor %}

      {% if has_next %}
        <li class="page-item">
          <a class="page-link bg-dark text-white border-secondary"
             href="{{ url_for('my_tickets', page=next_page) }}">
            Pr√≥xima ¬ª
          </a>
        </li>
      {% else %}
        <li class="page-item disabled">
          <span class="page-link bg-dark text-secondary border-secondary">Pr√≥xima ¬ª</span>
        </li>
      {% endif %}
    </ul>
  </nav>
{% endif %}


<style>
  .table-dark td, .table-dark th {
    color: #f8f9fa;
  }

  td.d-flex img:hover {
    transform: scale(1.1);
    box-shadow: 0 0 12px rgba(13, 110, 253, 0.3);
    transition: all 0.2s ease;
  }

  .badge {
    font-size: 0.75rem;
    padding: 6px 10px;
  }
</style>

<script>
  lucide.createIcons();
</script>
{% endblock %}
