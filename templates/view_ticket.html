{% extends 'base.html' %}

{% block content %}
<h2>Detalhes do Ticket #{{ ticket.id }}</h2>

<p><strong>T√≠tulo:</strong> {{ ticket.title }}</p>
<p><strong>Descri√ß√£o:</strong></p>
<div class="description-box mt-2">
    {{ ticket.description | safe }}
</div>
<p><strong>Solicitante:</strong> {{ ticket.requester_name }} ({{ ticket.requester_email }})</p>
<p><strong>Respons√°vel:</strong> {{ ticket.assigned_to if ticket.assigned_to else 'N√£o atribu√≠do' }}</p>
<p><strong>Criado em:</strong> {{ ticket.created_at.strftime('%d/%m/%Y %H:%M') }}</p>

<hr>

<!-- üîß FORM PRINCIPAL -->
<h4>Atualizar Ticket</h4>
<form method="POST">
    <div class="form-group">
        <label for="status">Status</label>
        <select name="status" class="form-control" required>
            <option value="Aberto" {% if ticket.status == 'Aberto' %}selected{% endif %}>Aberto</option>
            <option value="Em Andamento" {% if ticket.status == 'Em Andamento' %}selected{% endif %}>Em Andamento</option>
            <option value="Encerrado" {% if ticket.status == 'Encerrado' %}selected{% endif %}>Encerrado</option>
            <option value="Cancelado" {% if ticket.status == 'Cancelado' %}selected{% endif %}>Cancelado</option>
        </select>
    </div>

    <div class="form-group mt-2">
        <label for="priority">Prioridade</label>
        <select name="priority" class="form-control" required>
            <option value="Muito Baixa" {% if ticket.priority == 'Muito Baixa' %}selected{% endif %}>Muito Baixa</option>
            <option value="Baixa" {% if ticket.priority == 'Baixa' %}selected{% endif %}>Baixa</option>
            <option value="M√©dia" {% if ticket.priority == 'M√©dia' %}selected{% endif %}>M√©dia</option>
            <option value="Alta" {% if ticket.priority == 'Alta' %}selected{% endif %}>Alta</option>
            <option value="Muito Alta" {% if ticket.priority == 'Muito Alta' %}selected{% endif %}>Muito Alta</option>
        </select>
    </div>

    <div class="form-group mt-2">
        <label for="assigned_to">Respons√°vel</label>
        <select name="assigned_to" class="form-control">
            <option value="">N√£o atribu√≠do</option>
            {% for user in users %}
                <option value="{{ user.username }}" {% if ticket.assigned_to == user.username %}selected{% endif %}>
                    {{ user.first_name }} {{ user.last_name }}
                </option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group mt-4">
        <label for="comment">Coment√°rio</label>
        <textarea name="comment" class="form-control" placeholder="Adicione um coment√°rio (opcional)"></textarea>
    </div>

    <div class="d-flex justify-content-between mt-4">
        <a href="{{ url_for('tickets') }}" class="btn btn-secondary">Voltar</a>
        <button type="submit" class="btn btn-success">Salvar Altera√ß√µes</button>
    </div>
</form>

<hr>

<!-- üíæ FORM SEPARADO para ANEXOS -->
<h4>Anexar Arquivo</h4>
<form method="POST" enctype="multipart/form-data">
    <div class="form-group">
        <input type="file" name="file" class="form-control" required>
    </div>
    <button type="submit" class="btn btn-warning mt-2">Anexar Arquivo</button>
</form>

<hr>

<!-- üí¨ Coment√°rios -->
<h4>Coment√°rios</h4>
<ul class="list-group mt-3">
    {% for comment in comments %}
    <li class="list-group-item">
        <strong>{{ comment.commenter }}</strong> ({{ comment.commented_at.strftime('%d/%m/%Y %H:%M') }}):<br>
        {{ comment.comment }}
    </li>
    {% else %}
    <li class="list-group-item">Nenhum coment√°rio ainda.</li>
    {% endfor %}
</ul>

<hr>

<!-- üìé Anexos -->
<h4>Anexos</h4>
<ul class="list-group mt-3">
    {% for attachment in attachments %}
    <li class="list-group-item">
        <a href="{{ url_for('download_file', filename=attachment.filename) }}" target="_blank">{{ attachment.filename }}</a>
        ({{ attachment.uploaded_at.strftime('%d/%m/%Y %H:%M') }})
    </li>
    {% else %}
    <li class="list-group-item">Nenhum anexo ainda.</li>
    {% endfor %}
</ul>

<hr>

<!-- üïí Hist√≥rico -->
<h4>Hist√≥rico de Altera√ß√µes</h4>
<ul class="list-group mt-3">
    {% for item in history %}
    <li class="list-group-item">
        <strong>{{ item.changed_by }}</strong> em {{ item.changed_at.strftime('%d/%m/%Y %H:%M') }}:<br>
        {{ item.change_description }}
    </li>
    {% else %}
    <li class="list-group-item">Nenhum hist√≥rico de altera√ß√µes ainda.</li>
    {% endfor %}
</ul>
{% endblock %}
