{% extends 'base.html' %}
{% block title %}Dashboard | BenDesk{% endblock %}

{% block content %}
<div class="container-fluid">
  <h2 class="fw-bold mb-4">📊 Visão Geral</h2>

  <!-- ===== MÉTRICAS ===== -->
  <div class="row g-4">
    <div class="col-md-3">
      <div class="card text-center p-4">
        <i data-lucide="folder-plus" class="mb-2" style="color: var(--accent);"></i>
        <p class="metric-value">{{ open_count }}</p>
        <p class="metric-label">Abertos</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center p-4">
        <i data-lucide="loader" class="mb-2" style="color: var(--accent-3);"></i>
        <p class="metric-value">{{ in_progress_count }}</p>
        <p class="metric-label">Em Andamento</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center p-4">
        <i data-lucide="check-circle" class="mb-2" style="color: var(--accent-2);"></i>
        <p class="metric-value">{{ closed_count }}</p>
        <p class="metric-label">Encerrados</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center p-4">
        <i data-lucide="clock" class="mb-2" style="color: #6f42c1;"></i>
        <p class="metric-value">{{ avg_resolution }}</p>
        <p class="metric-label">Tempo Médio</p>
      </div>
    </div>
  </div>

    <!-- ===== Tabela de Resumo ===== -->
<div class="card p-4 mt-4">
  <h5 class="fw-bold mb-3"><i data-lucide="list" class="me-2"></i> Resumo dos Ativos</h5>
  <div class="table-responsive">
    <table class="table table-dark table-hover align-middle">
      <thead>
        <tr class="text-secondary text-uppercase small">
          <th>Tipo de Ativo</th>
          <th>Quantidade</th>
        </tr>
      </thead>
      <tbody>
          {% for tipo, qtd in ativos_zip %}
        <tr>
          <td class="fw-semibold text-white">{{ tipo }}</td>
          <td>{{ qtd }}</td>
        </tr>
          {% else %}
        <tr>
          <td colspan="2" class="text-center text-secondary py-3">Nenhum ativo registrado.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
  
  <!-- ===== GRÁFICOS ===== -->
  <div class="row mt-5">
    <div class="col-md-7">
      <div class="card p-4">
        <h5 class="fw-bold mb-3"><i data-lucide="bar-chart-3" class="me-2"></i> Chamados</h5>
        <canvas id="chartChamados" height="120"></canvas>
      </div>
    </div>
    <div class="col-md-5">
      <div class="card p-4">
        <h5 class="fw-bold mb-3"><i data-lucide="pie-chart" class="me-2"></i> Ativos</h5>
        <canvas id="chartAtivos" height="120"></canvas>
      </div>
    </div>
  </div>

</div>



<!-- ===== SCRIPTS ===== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  lucide.createIcons();

  // ===== Chamados =====
  const chamadosData = JSON.parse('{{ [open_count, in_progress_count, closed_count] | tojson | safe }}');

  new Chart(document.getElementById('chartChamados'), {
    type: 'bar',
    data: {
      labels: ['Abertos', 'Em Andamento', 'Encerrados'],
      datasets: [{
        data: chamadosData,
        backgroundColor: ['#0d6efd', '#ffc107', '#198754'],
        borderRadius: 8
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { color: '#fff' }, grid: { display: false } },
        y: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } }
      },
      animation: { duration: 1200 }
    }
  });

  // ===== Ativos (dados reais e dinâmicos do banco) =====
  const ativosLabels = JSON.parse('{{ ativos_labels | tojson | safe }}');
  const ativosCounts = JSON.parse('{{ ativos_counts | tojson | safe }}');

  new Chart(document.getElementById('chartAtivos'), {
    type: 'doughnut',
    data: {
      labels: ativosLabels,
      datasets: [{
        data: ativosCounts,
        backgroundColor: [
          '#0d6efd', '#6610f2', '#198754', '#6c757d',
          '#dc3545', '#20c997', '#ffc107', '#fd7e14'
        ],
        borderWidth: 0
      }]
    },
    options: {
      plugins: {
        legend: {
          position: 'bottom',
          labels: { color: '#fff', padding: 15 }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              let label = context.label || '';
              let value = context.formattedValue || 0;
              return `${label}: ${value} ativo(s)`;
            }
          }
        }
      },
      animation: { animateScale: true }
    }
  });
</script>


{% endblock %}
